<!DOCTYPE html>
<html>
  <header><style>.hiddenSong>p{display:none}</style></header>
<body>
    <input id="input" type="text" value="data"/>
    <button id="submit" type="button" >search</button>
    <div id="output">
      <div class="hiddenSong" onclick="this.classList.toggle('hiddenSong');">
        <h1>song title example</h1>
        <p>line before before line</p>
        <p>a little bit of the song <mark>found world</mark> and the rest of the song</p>
      </div>
      <!-- <div class="hiddenSong" onclick="this.classList.toggle('hiddenSong');">
        <h1>another song</h1>
        <p>a marea axe <mark>found world</mark> and other stuff</p>
        <p>line after after line</p>
      </div>
      <div class="hiddenSong" onclick="this.classList.toggle('hiddenSong');">
        <h1>little princess</h1>
        <p>line before before linee before before line before before lin</p>
        <p>aclomae udduanne a <mark>found world</mark> cicci na le</p>
        <p>line after after line</p>
      </div>
      <div class="hiddenSong" onclick="this.classList.toggle('hiddenSong');">
        <h1>song number 4</h1>
        <p>4 songs were going to peach <mark>found world</mark> just 5 came back</p>
      </div>
      <div class="hiddenSong" onclick="this.classList.toggle('hiddenSong');">
        <h1>English Result</h1>
        <p>all the text is english <mark>found world</mark></p>
      </div>
      <div class="hiddenSong" onclick="this.classList.toggle('hiddenSong');">
        <h1>Portuguese Resultado</h1>
        <p>todo o teistu en portuguese <mark>palabra</mark></p>
      </div> -->
    </div>
<script>
const input = document.getElementById("input");
const output = document.getElementById("output");
const submit = document.getElementById("submit");

submit.onclick = function(){
    startSearch(input.value)
}

async function startSearch(string){
    response = await getJsonFromServer(`${string}.json`);
    console.log(response)

    const resultsElmts = response.results.map((result)=>{
      resultEl = createResultElement(result.title,result.path);
      return resultEl;
    });

    
    resultsElmts.forEach((resultEl)=>
      output.appendChild(resultEl)
    );
}

function createResultElement(songTitle, path){
  const result = document.createElement("div");
  result.classList.add("hiddenSong");
  result.onclick=onOpenSong;

  const title = document.createElement("h1");
  const titleTxt = document.createTextNode(songTitle);
  title.appendChild(titleTxt);
  result.appendChild(title);

  result.dataset.path = path;

  return result;
}

async function onOpenSong(){
  //load song
  const path = this.dataset.path;
  song = await getJsonFromServer(path);

  //find lines to show
  const brazilianLines = song.lines.map((line)=>
    line.br
  );

  //TODO use correct word
  //find places to hightlight
  const word = "Berimbau".toLowerCase();

  const wordMatcher = '(?:^|\\W)('+word+')(?:\\W|$)';
  const lineWithWord = brazilianLines.find((line)=>{
    return new RegExp(wordMatcher).test(line.toLowerCase());
  });
  console.log(lineWithWord)
  console.log(new RegExp(wordMatcher,'g').exec(lineWithWord))

  // function findWordsInString(string, word, regex){
  //   let stringInSearch = string;
  //   const result = [];
  //   let lastSubstring = 0;
  //   let regexRes={};
  //   while(res == null || stringInSearch.length == 0){
  //     regexRes = new RegExp(regex,'g').exec(lineWithWord);
  //     const indexFound = regexRes.index;
  //     const wordFound = regexRes[0];

  //     result.push({start: lastSubstring+indexFound, end: lastSubstring+indexFound+word.length})
  //     stringInSearch = stringInSearch.substring(indexFound+wordFound.length);
  //     lastSubstring += indexFound+wordFound.length;
  //   }
  //   return result;
  // }


  //TODO add line to element with highlight
  const lines = brazilianLines.map((lineString)=>{
    const line = document.createElement("p");
    const lineTxt = document.createTextNode(lineString);
    line.appendChild(lineTxt);
    return line;
  });
  lines.forEach((line)=>
    this.appendChild(line)
  );
  
  //TODO make sure that future clicks don't reload the song from the server

  this.classList.toggle('hiddenSong');
}

async function getJsonFromServer(file) {
    const json = await makeRequestPromise('GET', file, {mimeType: 'application/json'})
    return JSON.parse(json);
}

function makeRequestPromise (method, url, options) {
  return new Promise(function (resolve, reject) {
    var xhr = new XMLHttpRequest();
    if(options && options.mimeType){
        xhr.overrideMimeType(options.mimeType);
    }
    xhr.open(method, url);
    xhr.onload = function () {
      if (xhr.status >= 200 && xhr.status < 300) {
        resolve(xhr.response);
      } else {
        reject({
          status: xhr.status,
          statusText: xhr.statusText
        });
      }
    };
    xhr.onerror = function () {
      reject({
        status: xhr.status,
        statusText: xhr.statusText
      });
    };
    xhr.send();
  });
}

</script>
</body>
</html>